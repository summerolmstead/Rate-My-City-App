<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurants in Chattanooga</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Restaurants in Chattanooga</h1>
        <nav>
            <ul>
                <li><a href="OriginalWebPage.html">Main Menu</a></li>
                <li><a href="chattanooga.html">Home</a></li>
                <li><a href="restaurants.html">Restaurants</a></li>
                <li><a href="hotels.html">Hotels</a></li>
                <li><a href="entertainment.html">Entertainment</a></li>
                <li><a href="healthcare.html">Healthcare</a></li>
            </ul>
        </nav>
    </header>

    <main id="place-list">
        <h2>Loading Restaurants...</h2>
    </main>

    <script>
        const API_KEY = '4dee9244ca9041a8a882f81b760bc3ac';  // Your Geoapify API key
        const placeList = document.getElementById('place-list');

        // Function to fetch restaurants from Geoapify API
        async function loadRestaurants() {
            try {
                const response = await fetch(
                    `https://api.geoapify.com/v2/places?categories=catering.restaurant&filter=circle:-85.29841879479977,35.071895836617216,100000&bias=proximity:-85.29841879479977,35.071895836617216&limit=20&apiKey=${API_KEY}`
                );
                const data = await response.json();

                placeList.innerHTML = '';  // Clear the loading message

                if (data.features.length > 0) {
                    data.features.forEach((place) => {
                        const name = place.properties.name || 'Name not available';
                        const streetAddress = place.properties.address_line1 || 'Street address not available';
                        const city = place.properties.city || 'City not available';
                        const phone = place.properties.phone || 'Phone number not available';
                        const website = place.properties.website || 'Website not available';
                        const placeId = place.properties.place_id;

                        // Initializing the rating as empty (0)
                        const initialRating = 0;

                        const item = document.createElement('div');
                        item.classList.add('place-item');
                        item.innerHTML = `
                            <h3>${name}</h3>
                            <p><strong>Street Address:</strong> ${streetAddress}</p>
                            <p><strong>City:</strong> ${city}</p>
                            <p><strong>Phone:</strong> ${phone}</p>
                            <p><strong>Website:</strong> <a href="${website}" target="_blank">${website}</a></p>
                            <div>
                                <strong>Rating: </strong>
                                <div id="rating-${placeId}" class="stars">${renderStars(initialRating)}</div>
                            </div>

                            <h4>Comments:</h4>
                            <ul id="comments-list-${placeId}">
                                <!-- Comments will go here -->
                            </ul>

                            <form id="rating-form-${placeId}">
                                <input type="number" name="rating" min="1" max="5" placeholder="Rate 1-5" required>
                                <button type="submit">Submit Rating</button>
                            </form>

                            <form id="comment-form-${placeId}">
                                <textarea name="comment" placeholder="Your comment here..." required></textarea>
                                <button type="submit">Submit Comment</button>
                            </form>
                        `;
                        placeList.appendChild(item);

                        // Handle rating form submission
                        document.getElementById(`rating-form-${placeId}`).addEventListener('submit', async (event) => {
                            event.preventDefault();
                            const rating = event.target.rating.value;  // Get rating value from input
                            const placeId = place.properties.place_id;  // Get place ID

                            // Validate that placeId is a non-empty string
                            if (typeof placeId !== 'string' || placeId.trim() === '') {
                                alert('Invalid place ID!');
                                return;
                            }

                            console.log('Submitting rating for place ID:', placeId);

                            const response = await fetch(`/rate/${placeId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ rating })  // Send the rating in the body
                            });

                            if (response.ok) {
                                alert('Rating submitted successfully!');
                                
                                // Get the updated place data (including the new rating)
                                const updatedPlace = await response.json();

                                // Now update the stars for this specific place
                                const starsContainer = document.getElementById(`rating-${placeId}`);
                                starsContainer.innerHTML = renderStars(updatedPlace.ratings.reduce((acc, rating) => acc + rating.rating, 0) / updatedPlace.ratings.length);  // Calculate average rating
                                
                            } else {
                                alert('Error submitting rating');
                            }
                        });

                        // Handle comment form submission
                        document.getElementById(`comment-form-${placeId}`).addEventListener('submit', async (event) => {
                            event.preventDefault();
                            const comment = event.target.comment.value;
                            const placeId = placeId; // Ensure you get the correct placeId

                            const response = await fetch(`/comment/${placeId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ text: comment })
                            });

                            if (response.ok) {
                                alert('Comment posted successfully!');
                                loadRestaurants(); // Refresh the restaurant list
                            } else {
                                alert('Error posting comment');
                            }
                        });
                    });
                } else {
                    placeList.innerHTML = '<p>No restaurants found.</p>';
                }
            } catch (error) {
                console.error('Error fetching restaurant data:', error);
                placeList.innerHTML = '<p>Error loading restaurants.</p>';
            }
        }

        // Function to render stars (empty initially, based on rating)
        function renderStars(rating) {
            const stars = [];
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                stars.push('★');  // Full stars
            }
            if (halfStar) stars.push('☆');  // Half star
            for (let i = 0; i < emptyStars; i++) {
                stars.push('☆');  // Empty stars
            }

            return stars.join('');
        }

        loadRestaurants(); // Initial call to load restaurants
    </script>
</body>
</html>



